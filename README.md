# HighSTEAM Shop (Next.js)

Интернет‑магазин (доставка еды) на Next.js (App Router) с админ‑панелью, каталогом, корзиной и SQLite БД.

## Основной функционал

- Каталог товаров с бесконечной прокруткой (IntersectionObserver), подгрузка по 10 товаров.
- Фильтрация по категориям: Гриль, Фри, Соусы, Пиво, Напитки.
- Карточки товаров:
  - название, описание, цена, рейтинг (по числу заказов);
  - количество перед добавлением;
  - MUI‑уведомление при добавлении; эффект “Добавлено” на кнопке;
  - скругление верх/низ 30px; рейтинг в углу изображения.
- Корзина `/cart`:
  - адаптивная верстка;
  - редактирование количества, удаление товара (с подтверждением);
  - форма с полями Имя (обязательно), Телефон (маска +7-(XXX)-XX-XX-XX), Адрес (по умолчанию);
  - оформление заказа с сохранением в БД, показ ID заказа и MUI‑оповещениями;
  - вкладки “Ваши заказы” с хранением 30 дней (cookie token), удаление заказа;
  - отображение статуса заказа (ожидает/в обработке/выполнен) и автообновление без перезагрузки.
- Админка (после авторизации):
  - `/admin/products`: управление товарами (CRUD, загрузка фото), поиск по названию/описанию, фильтр по категориям, мобильная адаптация;
  - `/admin/categories`: управление категориями (CRUD), мобильная адаптация;
  - `/admin/orders`: список заказов всех пользователей, смена статуса, мобильные карточки, чек‑лист по позициям заказа (сохранение отмеченных позиций в БД), автообновление без перезагрузки.
- Шапка сайта:
  - бургер‑меню, центрированный заголовок (“ЗАКАЗ ДОСТАВКИ ЕДЫ В БАНЮ”), иконка корзины справа;
  - “Войти” в меню; после входа появляются “Заказы” и “Аккаунт”, ниже — “Выйти”;
  - фиксированная (sticky) шапка при скролле;
  - плавающая кнопка корзины (FAB) на главной странице каталога при прокрутке.
- Единый фон сайта `#E7E0D6`.

## Технологии

- Next.js (App Router), React, TypeScript
- Tailwind CSS
- Material UI (Snackbar, Dialog, и др. уведомления/диалоги)
- SQLite (better-sqlite3)
- bcryptjs (хэш паролей администратора)

## Запуск проекта

Требуется Node.js LTS и Yarn.

```bash
# в корне проекта
yarn install
yarn dev
# откройте http://localhost:3000
```

Админ‑логин: `admin@ya.ru` / Пароль: `4321q` (создается при инициализации БД).

Примечания:
- Используется SQLite‑файл `data/shop.db`. Создаётся автоматически.
- Для Yarn PnP (если используете VS Code) можно сгенерировать SDK:
  ```bash
  yarn dlx @yarnpkg/sdks vscode
  ```

## Структура

- `app/` — страницы (App Router), API‑роуты
  - `app/page.tsx` — каталог товаров (инфинит‑скролл)
  - `app/cart/page.tsx` — корзина, оформление заказов
  - `app/login/page.tsx` — вход администратора
  - `app/admin/products/page.tsx` — товары (админ)
  - `app/admin/categories/page.tsx` — категории (админ)
  - `app/admin/orders/page.tsx` — заказы (админ)
  - `app/api/*` — серверные API (products, categories, orders, admin/*, auth/*)
- `components/` — UI‑компоненты (Header, ProductList, ProductCard, Admin*Table, CategoryBar)
- `lib/` — `db.ts` (инициализация БД, миграции/seed), `auth.ts` (сессии/куки)
- `public/products/` — изображения товаров (ссылки хранятся в БД)
- `data/shop.db` — база данных SQLite

## База данных и миграции

Основные таблицы: `categories`, `products`, `orders`, `order_items`, `admins`, `sessions`, `schema_migrations`.

Особенности:
- `products`: `name`, `description`, `price`, `rating`, `image`, `category_id`.
- `orders`: `total_price`, `client_token`, `expires_at`, `status`, `customer_*`.
- `order_items`: `order_id`, `product_id`, `quantity`, `price`, `checked` (для чек‑листа в админке).
- Рейтинг товара рассчитывается по количеству заказов, в которых он встречается.
- Реализован одноразовый перенос и обновления схемы (включая переименование `products4` → `products`).
- Сеединг данных и учётной записи админа.

## API (кратко)

- Публичные:
  - `GET /api/products` — список товаров (с `description`, `image`, `category_id`, расчетным `rating`)
  - `GET /api/categories`
  - `POST /api/orders` — создание заказа
  - `GET /api/orders/my` — заказы пользователя (по cookie‑токену)
- Админ:
  - `GET /api/admin/products`, `POST /api/admin/products`
  - `PATCH /api/admin/products/[id]`, `DELETE /api/admin/products/[id]`
  - `POST /api/admin/products/[id]/image` — загрузка фото
  - `GET /api/admin/categories`, `POST /api/admin/categories`
  - `PATCH /api/admin/categories/[id]`, `DELETE /api/admin/categories/[id]`
  - `GET /api/admin/orders` — все заказы + позиции
  - `PATCH /api/admin/orders/[id]` — смена статуса
  - `PATCH /api/admin/orders/items/[itemId]` — отметка чек‑листа (позиции)
- Аутентификация:
  - `POST /api/auth/login`, `POST /api/auth/logout`, `GET /api/auth/me`

## Аутентификация и сессии

- Админ‑сессия хранится в cookie `session` (7 дней).
- Серверные страницы админки проверяют сессию и редиректят на `/login`, если не авторизован.
- В шапке пункты «Заказы» и «Аккаунт» отображаются динамически после входа (без перезагрузки).

## UX/Адаптив

- Полная адаптивность каталога, корзины, админских таблиц (на малых экранах — карточки).
- Плавающая FAB‑иконка корзины на главной при скролле.
- Уведомления/диалоги — через MUI (`Snackbar`, `Alert`, `Dialog`).

## Скрипты

```json
yarn dev     # запуск dev‑сервера
yarn build   # сборка
yarn start   # прод‑сервер (нужен после сборки)
```

## Загрузка изображений

- Папка `public/products/` — хранение файлов изображений;
- В БД хранится путь к файлу (`image`), загрузка через админку.

---
Если потребуется, можно подключить SWR/React Query или WebSocket/SSE для «живых» обновлений без опроса на клиентах. Сейчас применяется периодическое обновление и on‑focus рефреш для заказов у пользователя и администратора.


