mhigh-steam.ru

// Пароль для админа
mhigh-steam.ru/login
E-mail: admin@ya.ru
Пароль: v9z-Yeb-hfi-6hg

Сайт меню бани
reg.ru
mhigh-steam.ru
ab.asatryan.015@mail.ru
v9z-Yeb-hfi-6hg
https://dnsadmin.hosting.reg.ru/manager/ispmgr

IP-адрес 193.227.240.138                                          \\\\
Доступ к серверу
Логин: root
Пароль: Wc8Mak8wtZShOxqP

cd /root/9972-mhighsteamshop
git fetch origin --prune
git reset --hard origin/main
git clean -fd
yarn install
yarn build
sudo nginx -t
sudo systemctl restart nextjs-mhighsteam
sudo systemctl status nextjs-mhighsteam --no-pager -l
curl -I http://127.0.0.1:3010

git@github.com:trRoman/9972-mHighSteamShop.git

yarn install
yarn build
yarn start
yarn dev
yarn cache clean

git add .
git commit -m "обновил"
git push

git pull

<!-- Для загрузки продуктов в базу данных. Используются файлы из data/import, scripts/import_grill.js -->
yarn import:grill

<!-- # жёстко обновить код с origin/main -->
cd /root/9972-mhighsteamshop
git fetch origin --prune
git reset --hard origin/main
yarn build
sudo systemctl stop nginx
sudo systemctl start nginx
sudo systemctl reload nginx
sudo systemctl restart nextjs-mhighsteam
sudo systemctl stop nextjs-mhighsteam
sudo systemctl status nextjs-mhighsteam --no-pager -l

ls -lt /root/9972-mhighsteamshop/.next/standalone/public/products | head

// изменить сервис
sudo systemctl edit --full nextjs-mhighsteam.service

Периодически мониторить место: df -h и du -x -h --max-depth=1 /var /usr /root | sort -h.
Проверка и запуск вручную:
sudo /usr/local/sbin/cleanup_web.sh
df -h

\\

ls -la
cp data/shop_backup9-1-2.db data/shop.db
cp data/shop.db data/shop_backup9-1-2.db
# остановить приложение/процесс
sqlite3 data/shop.db ".backup 'data/shop_backup.db'"
cp data/shop.db data/shop.db-wal data/shop.db-shm /path/to/backup/

1) Остановить приложение.
2) Бэкап:
sqlite3 ... .backup ...
tar -czf public_backup.tgz public
3) git fetch + git reset --hard
4) Восстановление:
восстановить data/shop.db из .backup (или подменить файлом)
rm -rf public и распаковать tar

rm data/shop.db
rm -r public
cp -r public public2
cp -r public2 public
cd /root/9972-mhighsteamshop/data/
cd /root/9972-mhighsteamshop/public/products
cd /root/9972-mhighsteamshop/backups
tar -czf public_backup.tgz public

rm -rf public
cp -a public2 public
# или (если public уже создан и надо залить внутрь)
cp -a public2/. public/

Восстановление:
rm -rf public
tar -xzf public_backup.tgz

\\
<!-- Резервная копия -->
set -euo pipefail; TS="$(date +%F_%H-%M-%S)"; BK="backups/$TS"; mkdir -p "$BK"; \
sudo systemctl stop nextjs-mhighsteam; \
if command -v sqlite3 >/dev/null 2>&1; then sqlite3 data/shop.db ".backup '$BK/shop.db'"; else cp -a data/shop.db data/shop.db-wal data/shop.db-shm "$BK/" 2>/dev/null || cp -a data/shop.db "$BK/"; fi; \
tar -czf "$BK/public.tgz" public; \
git fetch origin --prune && git reset --hard origin/main; \
cp -a "$BK/shop.db" data/shop.db 2>/dev/null || true; \
cp -a "$BK/shop.db-wal" "$BK/shop.db-shm" data/ 2>/dev/null || true; \
rm -rf public && tar -xzf "$BK/public.tgz"; \
sudo systemctl start nextjs-mhighsteam; \
echo "OK -> $BK"

<!-- Поднимаем из резервной копии -->
set -o pipefail; BK="backups/2026-01-28_19-19-17"; \
sudo systemctl stop nextjs-mhighsteam; \
[ -f "$BK/shop.db" ] && cp -a "$BK/shop.db" data/shop.db; \
cp -a "$BK/shop.db-wal" "$BK/shop.db-shm" data/ 2>/dev/null || true; \
rm -rf public; tar -xzf "$BK/public.tgz"; \
sudo systemctl start nextjs-mhighsteam; \
echo "RESTORED <- $BK"

\\

curl -I http://mhigh-steam.ru

sudo nano /etc/nginx/sites-available/mhighsteam


  server {
         listen 80;
         server_name mhigh-steam.ru www.mhigh-steam.ru;
         return 301 https://$host$request_uri;
      }
    
      server {
        listen 443 ssl http2;
         server_name mhigh-steam.ru www.mhigh-steam.ru;
    
        ssl_certificate /etc/letsencrypt/live/mhigh-steam.ru-0001/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/mhigh-steam.ru-0001/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
        client_max_body_size 50m;
    
        location ~ /\. { deny all; return 403; }
    
        # ВАЖНО: без alias — всё отдаёт Next.js, включая /products/*
        location / {
            proxy_pass http://127.0.0.1:3010;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_request_buffering off;
            proxy_connect_timeout 5s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }
    }